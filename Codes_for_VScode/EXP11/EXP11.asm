
DATA SEGMENT
	COUNT DB ?
	LOS DB ?	
	BUF DB 'SUN'
	KEY DB ' KEY'
	KEYN DB ?
DATA ENDS

STACK SEGMENT STACK
	DW 200H DUP(?)
STACK ENDS


CODE SEGMENT
	ASSUME CS:CODE,SS:STACK,DS:DATA

START:
	MOV AX,STACK
	MOV SS,AX
	MOV AX,DATA
	MOV DS,AX
	MOV AX,0
	MOV ES,AX
;保存原1CH中断向量
	MOV AX,ES:[70H]
	PUSH AX
	MOV AX,ES:[72H]
	PUSH AX
;置1CH中断向量
	CLI
	MOV AX,OFFSET TIMERINTS
	MOV ES:[70H],AX
	MOV AX,SEG TIMERINTS
	MOV ES:[72H],AX
	STI
;保存原09H的中断
	MOV AX,ES:[09H*4]
	PUSH AX
	MOV AX,ES:[09H*4+2]
	PUSH AX
	PUSH DS
;置09H中断向量
	CLI
	MOV	AX, SEG KEYINT
	MOV	DS, AX
	MOV	DX, OFFSET KEYINT
	MOV	AL, 09H				
	MOV	AH, 25H
	INT	21H
	STI
	POP DS;
	
;计数值置0
	MOV LOS,0
	MOV COUNT,0
	MOV KEYN,0
;调用DISP1显示太阳
AGAIN:
	CALL FAR PTR DISP1
	CMP KEYN,10
	JAE N
	CMP LOS,10
	JAE N
	JMP AGAIN
;恢复09H中断
N:	CLI
	POP ES:[09H*4+2]
	POP ES:[09H*4]
	STI
;恢复1CH向量
M:	CLI
	POP ES:[72H]
	POP ES:[70H]
	STI
STOP:
	MOV AH,4CH
	INT 21H




;显示太阳的子程序
DISP1 PROC FAR
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
;BIOS中断调用，屏幕显示
;读当前显示状态
	MOV AH,15 
	INT 10H
;设置显示模式40*25黑白
	MOV AH,0
	INT 10H
	MOV DX,0 ;行号为0，列号为0
REPT:
;附加任务，10次显示SUN后立即停止返回DOS
	CMP LOS,10
	JB K1
	JMP W
;附加任务，10次键盘后立即停止返回DOS
K1:	CMP KEYN,10
	JB K2
	JMP W
;设置光标位置
K2:	MOV AH,2
	INT 10H
;写字符及属性到当前光标位置处
	MOV AL,0FH
	MOV CX,1
	MOV BL,47H	;附加任务，红底白字
	MOV AH,9
	INT 10H

;每隔一段时间显示一次
	CALL DELAY
;清除该位置太阳图标
	SUB AL,AL
	MOV AH,10
	INT 10H
;每次移动一下光标
	INC DH
	ADD DL,2
	CMP DH,24
	JB REPT
W:	POP DX
	POP CX
	POP BX
	POP AX
	RET
DISP1 ENDP

;显示字符串“SUN”的子程序
DISP2  PROC   FAR
	PUSH   CX    
	PUSH   BX
	PUSH   AX
	MOV    CX,3
;采用BCD组合码显示
	PUSH   AX
	MOV AL,0
	ADD AL,LOS
	DAA
;十位
 	PUSH CX
	MOV CL,4
	SHR AL,CL
	POP CX
	ADD AL,'0'
	MOV   AH,0EH
	MOV   BX,01
	INT    10H
;个位
	MOV AL,LOS
	DAA
	AND AL,0FH
	ADD AL,'0'
	MOV   AH,0EH
	MOV   BX,01
	INT    10H	
	POP AX
	CLD
NEXTC1: 
	LODSB   ;AL<--[SI]
	MOV   AH,0EH
	MOV   BX,01
	INT    10H
	CALL   DELAY
	LOOP   NEXTC1
	POP    AX
	POP    BX
	POP    CX
	RET
DISP2    ENDP

;附加任务，显示字符串“KEY”的子程序
DISP3  PROC   FAR
	PUSH   CX    
	PUSH   BX
	PUSH   AX

;采用BCD组合码显示
	PUSH   AX
	MOV AL,0
	ADD AL,KEYN
	DAA
;十位
 	PUSH CX
	MOV CL,4
	SHR AL,CL
	POP CX
	ADD AL,'0'
	MOV   AH,0EH
	MOV   BX,01
	INT    10H
;个位
	MOV AL,KEYN
	DAA
	AND AL,0FH
	ADD AL,'0'
	MOV   AH,0EH
	MOV   BX,01
	INT    10H	
	POP AX
	CLD
	MOV    CX,4
	MOV SI,OFFSET KEY
NEXTC2: 
	LODSB   ;AL<--[SI]
	MOV   AH,0EH
	MOV   BX,01
	INT    10H
	CALL   DELAY
	LOOP   NEXTC2
	POP    AX
	POP    BX
	POP    CX
	RET
DISP3    ENDP

;延时程序
DELAY PROC
	PUSH CX
	PUSH DX
	MOV DX,130
DL500:
	MOV CX,2801
DL10MS:
	LOOP DL10MS 
	DEC DX
	JNZ DL500
	POP DX
	POP CX
	RET
DELAY ENDP

;设置计时器中断服务子程序
TIMERINTS PROC FAR
	PUSH AX
	PUSH SI
	CLI
	INC COUNT
	CMP COUNT,18   ;定时1秒左右
	JNE GO1
	MOV COUNT,0;每到50次清零
	MOV SI,OFFSET BUF
	INC LOS;计数10次停止
	CALL FAR PTR DISP2	
GO1:
	POP SI
	POP AX
	STI
	IRET
TIMERINTS ENDP

;设置键盘中断服务程序
KEYINT PROC FAR
;保护现场
	PUSH AX
	PUSH SI
	PUSH DX
	PUSH BX
;关中断
	CLI
;读取键盘扫描码
	IN AL,60H
	MOV AH,AL
;输出一个正脉冲
	IN AL,61H
	OR AL,80H
	OUT 61H,AL
	AND AL,7FH
	OUT 61H,AL
;判断：无键按下则执行退出键盘中断
	TEST AH,80H
	JNE GO2
;有键按下则显示KEY，KEYN同时计数
	MOV SI,OFFSET KEY
	INC KEYN
	CALL FAR PTR DISP3
GO2:
;EOI命令
	MOV AL,20H
	OUT 20H,AL
	POP BX
	POP DX
	POP SI
	POP AX
	STI
	IRET
KEYINT ENDP

CODE ENDS
	END START
